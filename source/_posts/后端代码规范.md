---
title: 后端代码规范
date: 2018-12-10 11.10
categories: 
- 规范
tags:
- 开发
---

## 关于规范
>* 之前写代码感觉都是一人一套,大家看的都很累, 代码是写给人看的
>* leader总结的规范真好用 参考Alibaba Java规范

## 命名风格
【强制】代码中的命名均不能以下划线或美元符号开始，也不能以下划线或美元符号结束。
 
    反例:_name / __name / $name / name_ / name$ / name__

【强制】代码中的命名严禁使用拼音与英文混合的方式，更不允许直接使用中文的方式。 

    说明:正确的英文拼写和语法可以让阅读者易于理解，避免歧义。注意，即使纯拼音命名方式 也要避免采用。
    
    正例:alibaba / taobao / youku / hangzhou 等国际通用的名称，可视同英文。 
    反例:DaZhePromotion [打折] / getPingfenByName() [评分] / int 某变量 = 3
【强制】类名使用 UpperCamelCase 风格，但以下情形例外:DO / BO / DTO / VO / AO / PO / UID等。
    
    正例:MarcoPolo / UserDO / XmlService / TcpUdpDeal / TaPromotion 
    反例:macroPolo / UserDo / XMLService / TCPUDPDeal / TAPromotion
【强制】方法名、参数名、成员变量、局部变量都统一使用 lowerCamelCase 风格，必须遵从小驼峰形式。
    
    正例: localValue / getHttpMessage() /inputUserId
【强制】常量命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。         

    正例:MAX_STOCK_COUNT
    反例:MAX_COUNT
【强制】抽象类命名使用 Abstract 或 Base 开头;异常类命名使用 Exception 结尾;测试类 命名以它要测试的类的名称开始，以 Test 结尾;接口命令使用Interface 结尾；trait使用Trait结尾

【强制】namespace统一使用小写，分隔符之间有且仅有一个自然语义的英语单词。命名空间统一使用 单数形式，但是类名如果有复数含义，类名可以使用复数形式。
    
    正例:应用工具类包名为 com\alibaba\ai\util、类名为 MessageUtils

【强制】杜绝完全不规范的缩写，避免望文不知义。
    
    反例:AbstractClass“缩写”命名成 AbsClass;condition“缩写”命名成 condi，此类随 意缩写严重降低了代码的可阅读性。

【推荐】为了达到代码自解释的目标，任何自定义编程元素在命名时，使用尽量完整的单词 组合来表达其意。
    
    正例:在 JDK 中，表达原子更新的类名为:AtomicReferenceFieldUpdater。
    
    反例:变量 int a 的随意命名方式。

【推荐】如果模块、接口、类、方法使用了设计模式，在命名时需体现出具体模式。 
	
	说明:将设计模式体现在名字中，有利于阅读者快速理解架构设计理念。
    
    正例:public class OrderFactory;public class LoginProxy; public class ResourceObserver;
    
 【参考】各层命名规约:

	A) Service
	    1) 获取单个对象的方法用get做前缀。
	    2) 获取多个对象的方法用list做前缀，复数形式结尾.如:listObjects。 
	    3) 获取统计值的方法用count做前缀。
	    4) 插入的方法用save/insert做前缀。
	    5) 删除的方法用remove/delete做前缀。
	    6) 修改的方法用update做前缀。

	B) 领域模型命名规约
	    1) 数据对象:xxxModel，xxx即为数据表名。
 
### 常量定义
【强制】不允许任何魔法值(即未经预先定义的常量)直接出现在代码中。 
    
    反例:String key = "Id#taobao_" + tradeId;
    cache.put(key, value);

【推荐】不要使用一个常量类维护所有常量，要按常量功能进行归类，分开维护。 
   
    说明:大而全的常量类，杂乱无章，使用查找功能才能定位到修改的常量，不利于理解和维护。    
    正例:缓存相关常量放在类 CacheConsts 下;
    系统配置相关常量放在类 ConfigConsts 下。

### 文件
PHP文件名使用大驼峰命名方式  UpperCamelCase

PHP代码文件 必须 以 <?php 或 <?= 标签开始；

当文件是PHP代码和HTML代码混合的时候，PHP结束标签?>不允许省略，纯PHP代码文件 必须 省略最后的 ?> 结束标签。

PHP代码文件 必须 以 不带 BOM 的 UTF-8 编码；

所有PHP文件 必须 使用 Unix LF (linefeed) 作为行的结束符。

PHP文件代码中 应该 只定义类、函数、常量等声明，或其他会产生 副作用 的操作（如：生成文件输出以及修改 .ini 配置文件等），二者只能选其一；

## 基本约定

每个不同含义的块，代码 必须 使用4个空格符而不是「Tab 键」进行缩进。

每行 一定不可 存在多于一条语句

PHP所有 关键字 必须 全部小写。常量 true 、false 和 null 也 必须 全部小写。

应该 使用关键词 elseif 代替所有 else if ，以使得所有的控制关键字都像是单独的一个词。

## 代码格式

namespace 声明后 必须 插入一个空白行。所有 use 必须 在 namespace 后声明。每条 use 声明语句 必须 只有一个 use 关键词。use 声明语句块后 必须 要有一个空白行。

关键词 extends 和 implements 必须 写在类名称的同一行。类的开始花括号 必须 独占一行，结束花括号也 必须 在类主体后独占一行。

每个属性都 必须 添加访问修饰符。一定不可 使用关键字 var 声明一个属性。每条语句 一定不可 定义超过一个属性。

所有方法都 必须 添加访问修饰符。方法名称后 一定不可 有空格符，其开始花括号 必须 独占一行，结束花括号也 必须 在方法主体后单独成一行。参数左括号后和右括号前 一定不可 有空格。

方法参数列表中，逗号前面 一定不可 有空格,逗号后面 必须 要有一个空格。有默认值的参数，必须 放到参数列表的末尾。

需要添加 abstract 或 final 声明时，必须 写在访问修饰符前，而 static 则 必须 写在其后。

方法及函数调用时，方法名或函数名与参数左括号之间 一定不可 有空格，参数左括号后和右括号前 一定不可 有空格。多个参数逗号后面必须加空格。

任何二目、三目运算符(=,==,&+-*/)的左右两边都需要加一个空格。但字符串连接符 . 运算符除外. 一元运算符不可加空格，比如 ++ -- !.

标准的 switch ，case 语句 必须 相对 switch 进行一次缩进，而 break 语句以及 case 内的其它语句都 必须 相对 case 进行一次缩进。

在一个 switch 块内，每个 case 要么通过 break/return 等来终止，要么注释说明程 序将继续执行到哪一个 case 为止;在一个 switch 块内，都必须包含一个 default 语句并且 放在最后，即使空代码。

在 if/else/for/while/do 语句中必须使用大括号。即使只有一行代码，避免采用 单行的编码方式


单行字符数限制不超过 120 个，超出需要换行，换行时遵循如下原则: 

1) 第二行相对第一行缩进 4 个空格，从第三行开始，不再继续缩进，参考示例。

2) 运算符与下文一起换行。

3) 方法调用的点符号与下文一起换行。

4) 方法调用中的多个参数需要换行时，在逗号后进行。 

5) 在括号前不要换行

```
正例:
StringBuffer sb = new StringBuffer();
// 超过 120 个字符的情况下，换行缩进 4 个空格，点号和方法名称一起换行 
sb.append("zi").append("xin")...
  .append("huang")...
  .append("huang")...
  .append("huang");
反例:
StringBuffer sb = new StringBuffer();
// 超过 120 个字符的情况下，不要在括号前换行 
sb.append("zi").append("xin")...append
    ("huang");
// 参数很多的方法调用可能超过 120 个字符，不要在逗号前换行 
method(args1, args2, args3, ...
, argsX);
```


## 最佳实践
避免出现重复的代码(Don’t Repeat Yourself)，即DRY原则。

单个方法的总行数不超过 80 行。 

    说明:包括方法签名、结束右大括号、方法内代码、注释、空行、回车及任何不可见字符的总 行数不超过 80 行。 
    
    正例:代码逻辑分清红花和绿叶，个性和共性，绿叶逻辑单独出来成为额外方法，使主干代码 更加清晰;共性逻辑抽取成为共性方法，便于复用和维护。

不同逻辑、不同语义、不同业务的代码之间插入一个空行分隔开来以提升可读性。

避免通过一个类的对象引用访问此类的静态变量或静态方法，无谓增加编译器解析成本，直接用类名来访问即可。

不能使用过时的类或方法。

构造方法里面禁止加入任何业务逻辑，如果有初始化逻辑，请放在 init 方法中。

类内方法定义的顺序依次是:公有方法或保护方法 > 私有方法 > getter/setter 方法。当一个类有多个构造方法，或者多个同名方法，这些方法应该按顺序放置在一起， 便于阅读，此条规则优先前面

类成员与方法访问控制从严:

1) 如果不允许外部直接通过new来创建对象，那么构造方法必须是private。 

2) 工具类不允许有public或default构造方法。

3) 类非static成员变量并且与子类共享，必须是protected。

4) 类非static成员变量并且仅在本类使用，必须是private。

5) 类static成员变量如果仅在本类使用，必须是private。

6) 若是static成员变量，考虑是否为final。

7) 类成员方法只供类内部调用，必须是private。

8) 类成员方法只对继承类公开，那么限制为protected。

说明:任何类、方法、参数、变量，严控访问范围。过于宽泛的访问范围，不利于模块解耦。
 思考:如果是一个 private 的方法，想删除就删除，可是一个 public 的 service 成员方法或 成员变量，删除一下，不得手心冒点汗吗?变量像自己的小孩，尽量在自己的视线内，变量作 用域太大，无限制的到处跑，那么你会担心的。

在高并发场景中，避免使用”等于”判断作为中断或退出的条件。

    说明:如果并发控制没有处理好，容易产生等值判断被“击穿”的情况，使用大于或小于的区间 判断条件来代替。
    反例:判断剩余奖品数量等于 0 时，终止发放奖品，但因为并发处理错误导致奖品数量瞬间变 成了负数，这样的话，活动无法终止。

表达异常的分支时，少用 if-else 方式，这种方式可以改写成:
``` 
if (condition) { ...
    return obj; 
}
// 接着写 else 的业务逻辑代码;
```
    说明:如果非得使用 if()...else if()...else...方式表达逻辑，避免后续代码维
    护困难，请勿超过 3 层。
    
    超过 3 层的 if-else的逻辑判断代码可以使用卫语句、策略模式、状态模式等来实现， 
    
    
在判断语句中尽量使用 ===  进行判断，除非明确需要进行类型转换，遇到常数判断，尽量常数在前，变量在后
```
    if(5 === $input) {
        ...
    }
```

除常用方法(如 getXxx/isXxx)等外，不要在条件判断中执行其它复杂的语句，将 复杂逻辑判断的结果赋值给一个有意义的布尔变量名，以提高可读性。涉及到运算符是一定要使用小括号隔开
```
final boolean existed = (file.open(fileName, "w") != null) && (...) || (...); 
if (existed) {
... 
}
```
循环体中的语句要考量性能，以下操作尽量移至循环体外处理，如定义对象、变量、
获取数据库连接，进行不必要的 try-catch 操作(这个 try-catch 是否可以移至循环体外)。

避免采用取反逻辑运算符。 

	说明:取反逻辑不利于快速理解，并且取反逻辑写法必然存在对应的正向逻辑写法。 

    正例:使用 if (x < 628) 来表达 x 小于 628。
    
    反例:使用 if (!(x >= 628)) 来表达 x 小于 628。

接口入参保护，这种场景常见的是用作批量操作的接口。

下列情形，需要进行参数校验:

1) 调用频次低的方法。

2) 执行时间开销很大的方法。此情形中，参数校验时间几乎可以忽略不计，但如果因为参数错误导致中间执行回退，或者错误，那得不偿失。

3) 需要极高稳定性和可用性的方法。

4) 对外提供的开放接口，不管是RPC/API/HTTP接口。 

5) 敏感权限入口。

下列情形，不需要进行参数校验:

1) 极有可能被循环调用的方法。但在方法说明里必须注明外部参数检查要求。

2) 底层调用频度比较高的方法。毕竟是像纯净水过滤的最后一道，参数错误不太可能到底层才会暴露问题。一般 DAO 层与 Service 层都在同一个应用中，部署在同一台服务器中，所 以 DAO的参数校验，可以省略。

3) 被声明成private只会被自己代码所调用的方法，如果能够确定调用方法的代码传入参 数已经做过检查或者肯定不会有问题，此时可以不校验参数。

### 注释规约
对于注释的要求:

第一、能够准确反应设计思想和代码逻辑;

第二、能够描述业务含义，使别的程序员能够迅速了解到代码背后的信息。完全没有注释的大段代码对于阅读者形同天书，注释是给自己看的，即使隔很长时间，也能清晰理解当时的思路;注释也是给继任者看 的，使其能够快速接替自己的工作。好的命名、代码结构是自解释的，注释力求精简准确、表达到位.

类、类属性、类方法的注释必须使用 使用/**内容*/格式，不得使用 //xxx方式。所有的类都必须添加创建者和创建日期。

所有的方法(包括接口中的方法)必须要用 /**内容 **/ 注释、除了返回值、参数、 异常说明外，还必须指出该方法做什么事情，实现什么功能。

方法内部单行注释，在被注释语句上方另起一行，使用//注释。方法内部多行注释,使用/* */注释，注意与代码对齐。

代码修改的同时，注释也要进行相应的修改，尤其是参数、返回值、异常、核心逻辑 等的修改。

谨慎注释掉代码。在上方详细说明，而不是简单地注释掉。如果无用，则删除。
说明:代码被注释掉有两种可能性:
 1)后续会恢复此段代码逻辑。
 2)永久不用。前者如果没有备注信息，难以知晓注释动机。后者建议直接删掉(代码仓库保存了历史代码)。

## 日志与异常，错误码

异常不要用来做流程控制，条件控制。	

尽量不使用异常

应用中的扩展日志(如打点、临时监控、访问日志等)
    
    命名方式: 
    appName_logType_logName.log。
    logType:日志类型，如 stats/monitor/access 等;
    logName:日志描述。
    这种命名的好处: 通过文件名就可知道日志文件属于什么应用，什么类型，什么目的，也有利于归类查找。
    正例:mppserver 应用中单独监控时区转换异常，如: mppserver_monitor_timeZoneConvert.log 
    说明:推荐对日志进行分类，如将错误日志和业务日志分开存放，便于开发人员查看，也便于 通过日志对系统进行及时监控。

谨慎地记录日志。生产环境禁止输出 debug 日志;有选择地输出 info 日志;如果使 用 warn 来记录刚上线时的业务行为信息，一定要注意日志输出量的问题，避免把服务器磁盘 撑爆，并记得及时删除这些观察日志。

    说明:大量地输出无效日志，不利于系统性能提升，也不利于快速定位错误点。记录日志时请 思考:这些日志真的有人看吗?看到这条日志你能做什么?能不能给问题排查带来好处?

【推荐】可以使用 warn日志级别来记录用户输入参数错误的情况，避免用户投诉时，无所适从。如非必要，请不要在此场景打出 error级别，避免频繁报警。

说明:注意日志输出的级别，error 级别只记录系统逻辑出错、异常或者重要的错误信息

## 安全实践
【推荐】使用 password_hash 来哈希密码

【强制】隶属于用户个人的页面或者功能必须进行权限控制校验。 说明:防止没有做水平权限校验就可随意访问、修改、删除别人的数据，比如查看他人的私信 内容、修改他人的订单。

【强制】用户敏感数据禁止直接展示，必须对展示数据进行脱敏。 

说明:中国大陆个人手机号码显示为:158****9119，隐藏中间 4 位，防止隐私泄露。

【强制】用户输入的 SQL 参数严格使用参数绑定或者 METADATA 字段值限定，防止 SQL 注入， 禁止字符串拼接 SQL 访问数据库。

【强制】用户请求传入的任何参数必须做有效性验证。 

    说明:忽略参数校验可能导致:
    page size 过大导致内存溢出
    恶意 order by 导致数据库慢查询 
    任意重定向
    SQL 注入
    反序列化注入
    
【强制】禁止向 HTML 页面输出未经安全过滤或未正确转义的用户数据。使用 strip_tags() 函数来去除 HTML 标签或者使用 htmlentities() 或是 htmlspecialchars() 函数来对特殊字符分别进行转义从而得到各自的 HTML 实体。

【强制】表单、AJAX 提交必须执行 CSRF 安全验证。

    说明:CSRF(Cross-site request forgery)跨站请求伪造是一类常见编程漏洞。对于存在 CSRF 漏洞的应用/网站，攻击者可以事先构造好 URL，只要受害者用户一访问，后台便在用户 不知情的情况下对数据库中用户参数进行相应修改。
【强制】在使用平台资源，譬如短信、邮件、电话、下单、支付，必须实现正确的防重放的机 制，如数量限制、疲劳度控制、验证码校验，避免被滥刷而导致资损。 

    说明:如注册时发送验证码到手机，如果没有限制次数和频率，那么可以利用此功能骚扰到其 它用户，并造成短信平台资源浪费。

【推荐】发贴、评论、发送即时消息等用户生成内容的场景必须实现防刷、文本内容违禁词过 滤等风控策略。


## 参考链接

[alibaba代码规范](https://github.com/alibaba/p3c)

[php之道](http://laravel-china.github.io/php-the-right-way/)

[psr](https://laravel-china.org/docs/psr)





























